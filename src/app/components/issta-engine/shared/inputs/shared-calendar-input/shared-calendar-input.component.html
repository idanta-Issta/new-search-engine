<div class="calendar-input-wrapper" #anchor>
  <app-input-box
    [icon]="uiConfig.icon ?? 'ng-icon-calendar'"
    [title]="uiConfig.title || 'תאריכים'"
    [placeholder]="isDisabled ? '' : (uiConfig.placeholder || 'בחר תאריך')"
    [isOpen]="isOpen && !isDisabled"
    [model]="valueAsString"
    [width]="width"
    (opened)="!isDisabled && onInputOpened()"
    (closed)="onInputClosed()"
    (select)="!isDisabled && onInputOpened()"
    (focusin)="!isDisabled && onInputOpened()"
    (click)="!isDisabled && onInputOpened()"
  ></app-input-box>

  <!--     [isOpen]="isOpen && !isDisabled"-->
  <!-- שימוש ב-dropdown המשותף -->
  <app-shared-dropdown
    [isOpen]="isOpen && !isDisabled"
    (closed)="onInputClosed()"
    [anchor]="anchor"
    [scrollable]="false"
    [position]="position"
  >
    <div class="dropdown-panel calendar-dropdown">
      <div *ngIf="loadingSuggestions" class="calendar-loading-overlay">
  טוען תאריכים...
      </div>
      <div class="calendar-wrapper">
        <div class="calendar-header">
          <div class="calendar-pill">
            <span class="label">יציאה</span>
            <span class="date">{{ formatFullHebrewDate(departureDate) }}</span>
          </div>
          <div class="calendar-pill">
            <span class="label">חזרה</span>
            <span class="date">{{ formatFullHebrewDate(returnDate) }}</span>
          </div>
        </div>

        <div class="calendar-body">
          <!-- חודש שמאל -->
          <div class="calendar-month">
            <div class="month-header">
              <button class="nav-btn" (click)="prevMonth(); $event.stopPropagation()">‹</button>
              <span class="month-name">
                <span class="month">{{ leftMonthName }}</span>
                <span class="year">{{ leftYear }}</span>
              </span>
            </div>

            <div class="weekday-row">
              <span *ngFor="let d of hebrewWeekdays">{{ d }}</span>
            </div>

            <div class="days-grid">
              <div
                *ngFor="let day of leftMonthDays"
                class="day"
                [class.other-month]="day.other"
                [class.selected]="isSelected(day.date)"
                [class.range]="isInRange(day.date)"
                [class.hover-range]="isInHoverRange(day.date)"
                [class.disabled]="day.disabled"
                [class.has-holiday]="day.holiday"
                (click)="selectDate(day)"
                (mouseenter)="onDateHover(day.date)"
                (mouseleave)="onDateHover(null)"
                (mousedown)="$event.stopPropagation()"
              >
                <span *ngIf="day.holiday" class="holiday-label">{{ getSimplifiedHoliday(day.holiday) }}</span>
                <span class="date-number">{{ day.date.getDate() }}</span>
                <span *ngIf="day.suggested" class="suggest-badge">
                   {{ day.suggested.currency }}{{ day.suggested.price }}
                </span>
              </div>
            </div>
          </div>

          <!-- חודש ימין -->
          <div class="calendar-month">
            <div class="month-header return">
              <button class="nav-btn" (click)="nextMonth(); $event.stopPropagation()">›</button>
              <span class="month-name">
                <span class="month">{{ rightMonthName }}</span>
                <span class="year">{{ rightYear }}</span>
              </span>
            </div>

            <div class="weekday-row">
              <span *ngFor="let d of hebrewWeekdays">{{ d }}</span>
            </div>

            <div class="days-grid">
              <div
                *ngFor="let day of rightMonthDays"
                class="day"
                [class.other-month]="day.other"
                [class.selected]="isSelected(day.date)"
                [class.range]="isInRange(day.date)"
                [class.hover-range]="isInHoverRange(day.date)"
                [class.disabled]="day.disabled"
                [class.has-holiday]="day.holiday"
                (click)="selectDate(day)"
                (mouseenter)="onDateHover(day.date)"
                (mouseleave)="onDateHover(null)"
                (mousedown)="$event.stopPropagation()"
              >
              <span *ngIf="day.holiday" class="holiday-label">{{ getSimplifiedHoliday(day.holiday) }}</span>
              <span class="date-label">{{ day.date.getDate() }}</span>
                <span *ngIf="day.suggested" class="suggest-badge">
                   {{ day.suggested.currency }}{{ day.suggested.price }}
                </span>
              </div>
            </div>
          </div>
        </div><!-- /calendar-body -->
      </div><!-- /calendar-wrapper -->
    </div>
  </app-shared-dropdown>
</div>
